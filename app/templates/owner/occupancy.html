{% extends "owner/base.html" %}

{% block title %}Tỷ lệ lấp đầy{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}

<div class="owner-header">
    <div>
        <h1 class="owner-header-title">
            <i class="fas fa-percentage me-2"></i> Tỷ lệ lấp đầy
        </h1>
        <p class="owner-header-subtitle">Theo dõi tỷ lệ lấp đầy của từng khách sạn</p>
    </div>
    <div class="owner-header-actions">
        <a href="{{ url_for('owner.dashboard') }}" class="owner-btn owner-btn-outline">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>
    </div>
</div>

{% set payload = result[0].json if result and result[1] == 200 else None %}
{% set data = payload.data if payload and payload.data else None %}
{% set occupancy = data.occupancy if data and data.occupancy else [] %}

{% if occupancy %}
    <!-- Summary Card -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="owner-stat-card" style="padding: 2rem;">
                <div class="owner-stat-content">
                    <h6>Tỷ lệ lấp đầy trung bình</h6>
                    <div class="stat-value" style="font-size: 3rem; color: #0d6efd;">
                        {{ "{:.1f}".format(data.avg_occupancy) if data and data.avg_occupancy else 0 }}%
                    </div>
                    <div class="stat-label">Tất cả khách sạn</div>
                </div>
                <div class="owner-stat-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Occupancy Chart -->
    <div class="owner-chart-card">
        <div class="owner-chart-header">
            <h3 class="owner-chart-title">
                <i class="fas fa-chart-bar me-2"></i> Biểu đồ tỷ lệ lấp đầy
            </h3>
        </div>
        <div style="position: relative; height: 400px;">
            <canvas id="occupancyChart"></canvas>
        </div>
    </div>

    <!-- Occupancy Table -->
    <div class="owner-table-wrapper">
        <div class="owner-table-header">
            <h3 class="owner-table-title">
                <i class="fas fa-table me-2"></i> Chi tiết theo khách sạn
            </h3>
            <span class="badge bg-info" style="font-size: 1rem; padding: 0.5rem 1rem;">
                {{ occupancy|length }} khách sạn
            </span>
        </div>
        <div class="table-responsive">
            <table class="owner-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tên khách sạn</th>
                        <th class="text-center">Tổng phòng</th>
                        <th class="text-center">Phòng đã đặt</th>
                        <th class="text-end">Tỷ lệ lấp đầy</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in occupancy %}
                    <tr>
                        <td><strong>#{{ item.hotel_id }}</strong></td>
                        <td>
                            <i class="fas fa-hotel text-primary me-2"></i>
                            <strong>{{ item.hotel_name }}</strong>
                        </td>
                        <td class="text-center">{{ item.total_rooms }}</td>
                        <td class="text-center">{{ item.occupied_rooms }}</td>
                        <td class="text-end">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ item.occupancy_rate }}%;" 
                                     aria-valuenow="{{ item.occupancy_rate }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    <strong>{{ "{:.1f}".format(item.occupancy_rate) }}%</strong>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('occupancyChart').getContext('2d');
        const occupancyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [{% for item in occupancy %}'{{ item.hotel_name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Tỷ lệ lấp đầy (%)',
                    data: [{% for item in occupancy %}{{ item.occupancy_rate }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: 'rgba(13, 110, 253, 0.5)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    </script>
{% else %}
    <div class="owner-empty-state">
        <div class="owner-empty-icon">
            <i class="fas fa-percentage"></i>
        </div>
        <h4 class="owner-empty-title">Không có dữ liệu</h4>
        <p class="owner-empty-text">Chưa có dữ liệu tỷ lệ lấp đầy để hiển thị.</p>
    </div>
{% endif %}

{% endblock %}
