<!DOCTYPE html>
<html>
<head>
    <title>Danh sách khuyến mãi</title>
</head>
<body>
    <h1>Danh sách khuyến mãi</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <p class="flash-{{ category }}">{{ message }}</p>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <p>
        <a href="{{ url_for('promotion.create_promotion') }}">Tạo khuyến mãi</a> |
        <a href="{{ url_for('promotion.active_promotions') }}">Xem đang hoạt động</a>
    </p>

    <form method="GET" action="{{ url_for('promotion.list_promotions') }}">
        <div>
            <label>Hotel ID:</label>
            <input type="number" name="hotel_id" value="{{ request.args.get('hotel_id', '') }}">
        </div>
        <div>
            <label>Room ID:</label>
            <input type="number" name="room_id" value="{{ request.args.get('room_id', '') }}">
        </div>
        <div>
            <label>Trạng thái:</label>
            <select name="is_active">
                <option value="">Tất cả</option>
                <option value="true" {% if request.args.get('is_active') == 'true' %}selected{% endif %}>Đang hoạt động</option>
                <option value="false" {% if request.args.get('is_active') == 'false' %}selected{% endif %}>Ngừng</option>
            </select>
        </div>
        <div>
            <label>Hiển thị mỗi trang:</label>
            <input type="number" min="1" name="per_page" value="{{ request.args.get('per_page', 10) }}">
        </div>
        <div>
            <button type="submit">Lọc</button>
            <a href="{{ url_for('promotion.list_promotions') }}">Xóa lọc</a>
        </div>
    </form>

    {% set payload = result[0].json if result and result[1] == 200 else None %}
    {% set promotions = payload.data if payload and payload.data else [] %}
    {% set pagination = payload.pagination if payload and payload.pagination else None %}

    {% if promotions %}
        <table border="1">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tiêu đề</th>
                    <th>Phạm vi</th>
                    <th>Loại giảm</th>
                    <th>Giá trị</th>
                    <th>Bắt đầu</th>
                    <th>Kết thúc</th>
                    <th>Ngày áp dụng</th>
                    <th>Đêm tối thiểu</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {% for promo in promotions %}
                <tr>
                    <td>{{ promo.promotion_id }}</td>
                    <td>{{ promo.title }}</td>
                    <td>
                        {% if promo.room %}
                            Phòng #{{ promo.room.room_id }}
                        {% elif promo.hotel %}
                            Khách sạn #{{ promo.hotel.hotel_id }}
                        {% else %}
                            Toàn hệ thống
                        {% endif %}
                    </td>
                    <td>{{ 'Phần trăm' if promo.discount_type == 'percentage' else 'Cố định' }}</td>
                    <td>{{ promo.discount_value }}</td>
                    <td>{{ promo.start_date }}</td>
                    <td>{{ promo.end_date }}</td>
                    <td>{{ promo.applicable_days or 'Tất cả' }}</td>
                    <td>{{ promo.min_nights or 1 }}</td>
                    <td>{{ 'Hoạt động' if promo.is_active else 'Ngừng' }}</td>
                    <td>
                        <a href="{{ url_for('promotion.promotion_detail', promotion_id=promo.promotion_id) }}">Chi tiết</a> |
                        <a href="{{ url_for('promotion.edit_promotion', promotion_id=promo.promotion_id) }}">Sửa</a>
                        <form method="POST" action="{{ url_for('promotion.delete_promotion', promotion_id=promo.promotion_id) }}" style="display:inline;">
                            <button type="submit" onclick="return confirm('Xóa khuyến mãi này?')">Xóa</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if pagination %}
            <p>Trang {{ pagination.page }} / {{ pagination.pages }} - Tổng {{ pagination.total }} khuyến mãi</p>
            <div>
                {% if pagination.page > 1 %}
                    <a href="{{ url_for('promotion.list_promotions', page=pagination.page - 1, per_page=pagination.per_page, hotel_id=request.args.get('hotel_id'), room_id=request.args.get('room_id'), is_active=request.args.get('is_active')) }}">« Trang trước</a>
                {% endif %}
                {% if pagination.page < pagination.pages %}
                    <a href="{{ url_for('promotion.list_promotions', page=pagination.page + 1, per_page=pagination.per_page, hotel_id=request.args.get('hotel_id'), room_id=request.args.get('room_id'), is_active=request.args.get('is_active')) }}">Trang sau »</a>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <p>Không có khuyến mãi nào.</p>
    {% endif %}
</body>
</html>

