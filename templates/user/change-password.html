<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đổi Mật Khẩu - Hotel Booking</title>
</head>
<body>
    <div>
        <div>
            <h1>Đổi Mật Khẩu</h1>
        </div>
        
        <div>
            <div id="errorContainer"></div>
            <div id="successContainer"></div>
            
            <form id="changePasswordForm">
                <div>
                    <label for="oldPassword">Mật khẩu hiện tại</label>
                    <div>
                        <input 
                            type="password" 
                            id="oldPassword" 
                            name="oldPassword" 
                            required 
                            placeholder="Nhập mật khẩu hiện tại"
                            autocomplete="current-password"
                        >
                        <button type="button" onclick="togglePassword('oldPassword')">
                            <span id="oldPasswordToggleText">Hiện</span>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="newPassword">Mật khẩu mới</label>
                    <div>
                        <input 
                            type="password" 
                            id="newPassword" 
                            name="newPassword" 
                            required 
                            placeholder="Nhập mật khẩu mới"
                            autocomplete="new-password"
                            oninput="checkPasswordStrength()"
                        >
                        <button type="button" onclick="togglePassword('newPassword')">
                            <span id="newPasswordToggleText">Hiện</span>
                        </button>
                    </div>
                    <div>
                        <div>
                            <div id="passwordStrengthFill"></div>
                        </div>
                        <span id="passwordStrengthText"></span>
                    </div>
                </div>

                <div>
                    <label for="confirmPassword">Xác nhận mật khẩu mới</label>
                    <div>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            name="confirmPassword" 
                            required 
                            placeholder="Nhập lại mật khẩu mới"
                            autocomplete="new-password"
                        >
                        <button type="button" onclick="togglePassword('confirmPassword')">
                            <span id="confirmPasswordToggleText">Hiện</span>
                        </button>
                    </div>
                </div>

                <button type="submit" id="submitBtn">Đổi Mật Khẩu</button>
            </form>

            <div>
                <a href="profile.html">Quay lại hồ sơ</a>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggleText = document.getElementById(inputId + 'ToggleText');
            
            if (input.type === 'password') {
                input.type = 'text';
                toggleText.textContent = 'Ẩn';
            } else {
                input.type = 'password';
                toggleText.textContent = 'Hiện';
            }
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthText = document.getElementById('passwordStrengthText');
            
            if (password.length === 0) {
                strengthText.textContent = '';
                return;
            }

            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;

            if (strength <= 1) {
                strengthText.textContent = 'Mật khẩu yếu';
            } else if (strength === 2) {
                strengthText.textContent = 'Mật khẩu trung bình';
            } else {
                strengthText.textContent = 'Mật khẩu mạnh';
            }
        }

        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const errorContainer = document.getElementById('errorContainer');
            const successContainer = document.getElementById('successContainer');
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            errorContainer.innerHTML = '';
            successContainer.innerHTML = '';

            if (!oldPassword || !newPassword || !confirmPassword) {
                errorContainer.innerHTML = '<div>Vui lòng điền đầy đủ thông tin</div>';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorContainer.innerHTML = '<div>Mật khẩu xác nhận không khớp</div>';
                return;
            }

            if (newPassword.length < 6) {
                errorContainer.innerHTML = '<div>Mật khẩu phải có ít nhất 6 ký tự</div>';
                return;
            }

            if (oldPassword === newPassword) {
                errorContainer.innerHTML = '<div>Mật khẩu mới phải khác mật khẩu hiện tại</div>';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Đang đổi mật khẩu...';

            try {
                const result = await userAPI.changePassword(oldPassword, newPassword);

                if (result.success) {
                    successContainer.innerHTML = `<div>${result.message || 'Đổi mật khẩu thành công!'}</div>`;
                    showMessage(result.message || 'Đổi mật khẩu thành công!', 'success');
                    document.getElementById('changePasswordForm').reset();
                    
                    setTimeout(() => {
                        window.location.href = 'profile.html';
                    }, 2000);
                } else {
                    errorContainer.innerHTML = `<div>${result.message || 'Đổi mật khẩu thất bại'}</div>`;
                    showMessage(result.message || 'Đổi mật khẩu thất bại', 'error');
                }
            } catch (error) {
                errorContainer.innerHTML = `<div>Lỗi: ${error.message}</div>`;
                showMessage('Có lỗi xảy ra. Vui lòng thử lại.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Đổi Mật Khẩu';
            }
        });

        window.addEventListener('DOMContentLoaded', async () => {
            const isValid = await verifyTokenWithBackend();
            if (!isValid) {
                window.location.href = '../auth/login.html';
            }
        });
    </script>
</body>
</html>

