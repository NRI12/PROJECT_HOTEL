<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn Đặt Phòng - Hotel Booking</title>
</head>
<body>
    <div>
        <div>
            <h1>Đơn Đặt Phòng Của Tôi</h1>
        </div>
        
        <div>
            <div id="errorContainer"></div>
            <div id="loadingContainer">Đang tải...</div>
            
            <div id="bookingsContainer"></div>
            
            <div id="paginationContainer"></div>
            
            <div>
                <a href="profile.html">Quay lại hồ sơ</a>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        let currentPage = 1;
        const perPage = 10;

        async function loadBookings(page = 1) {
            currentPage = page;
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const bookingsContainer = document.getElementById('bookingsContainer');
            const paginationContainer = document.getElementById('paginationContainer');

            loadingContainer.style.display = 'block';
            errorContainer.innerHTML = '';
            bookingsContainer.innerHTML = '';

            try {
                const result = await userAPI.getBookings(page, perPage);
                
                if (result.success && result.data) {
                    loadingContainer.style.display = 'none';
                    
                    if (result.data.length === 0) {
                        bookingsContainer.innerHTML = '<div>Bạn chưa có đơn đặt phòng nào</div>';
                        paginationContainer.innerHTML = '';
                        return;
                    }

                    let html = '';
                    result.data.forEach(booking => {
                        html += `
                            <div>
                                <div>
                                    <h3>Đơn #${booking.booking_id || booking.id}</h3>
                                    <div>Trạng thái: ${booking.status || 'N/A'}</div>
                                    <div>Ngày đặt: ${booking.created_at ? new Date(booking.created_at).toLocaleDateString('vi-VN') : 'N/A'}</div>
                                    <div>Tổng tiền: ${booking.total_amount ? booking.total_amount.toLocaleString('vi-VN') + ' VNĐ' : 'N/A'}</div>
                                </div>
                            </div>
                        `;
                    });
                    bookingsContainer.innerHTML = html;

                    if (result.pagination) {
                        displayPagination(result.pagination, paginationContainer);
                    }
                } else {
                    loadingContainer.style.display = 'none';
                    if (result.status === 401) {
                        window.location.href = '../auth/login.html';
                    } else {
                        errorContainer.innerHTML = `<div>${result.message || 'Không thể tải danh sách đơn đặt phòng'}</div>`;
                    }
                }
            } catch (error) {
                loadingContainer.style.display = 'none';
                errorContainer.innerHTML = `<div>Lỗi: ${error.message}</div>`;
            }
        }

        function displayPagination(pagination, container) {
            if (!pagination || pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<div>';
            
            if (pagination.page > 1) {
                html += `<button onclick="loadBookings(${pagination.page - 1})">Trước</button>`;
            }
            
            html += `<span>Trang ${pagination.page} / ${pagination.pages}</span>`;
            
            if (pagination.page < pagination.pages) {
                html += `<button onclick="loadBookings(${pagination.page + 1})">Sau</button>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const isValid = await verifyTokenWithBackend();
            if (!isValid) {
                window.location.href = '../auth/login.html';
                return;
            }
            await loadBookings(1);
        });
    </script>
</body>
</html>

