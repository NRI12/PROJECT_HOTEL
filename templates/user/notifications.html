<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Báo - Hotel Booking</title>
</head>
<body>
    <div>
        <div>
            <h1>Thông Báo</h1>
        </div>
        
        <div>
            <div id="errorContainer"></div>
            <div id="loadingContainer">Đang tải...</div>
            
            <div id="notificationsContainer"></div>
            
            <div id="paginationContainer"></div>
            
            <div>
                <a href="profile.html">Quay lại hồ sơ</a>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        let currentPage = 1;
        const perPage = 20;

        async function loadNotifications(page = 1) {
            currentPage = page;
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const notificationsContainer = document.getElementById('notificationsContainer');
            const paginationContainer = document.getElementById('paginationContainer');

            loadingContainer.style.display = 'block';
            errorContainer.innerHTML = '';
            notificationsContainer.innerHTML = '';

            try {
                const result = await userAPI.getNotifications(page, perPage);
                
                if (result.success && result.data) {
                    loadingContainer.style.display = 'none';
                    
                    if (result.data.length === 0) {
                        notificationsContainer.innerHTML = '<div>Bạn chưa có thông báo nào</div>';
                        paginationContainer.innerHTML = '';
                        return;
                    }

                    let html = '';
                    result.data.forEach(notification => {
                        const isRead = notification.is_read ? 'Đã đọc' : 'Chưa đọc';
                        html += `
                            <div>
                                <div>
                                    <h3>${notification.title || 'Thông báo'}</h3>
                                    <div>${notification.content || ''}</div>
                                    <div>Trạng thái: ${isRead}</div>
                                    <div>Ngày: ${notification.created_at ? new Date(notification.created_at).toLocaleDateString('vi-VN') : 'N/A'}</div>
                                    <div>
                                        ${!notification.is_read ? `<button onclick="markAsRead(${notification.notification_id || notification.id})">Đánh dấu đã đọc</button>` : ''}
                                        <button onclick="deleteNotification(${notification.notification_id || notification.id})">Xóa</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    notificationsContainer.innerHTML = html;

                    if (result.pagination) {
                        displayPagination(result.pagination, paginationContainer);
                    }
                } else {
                    loadingContainer.style.display = 'none';
                    if (result.status === 401) {
                        window.location.href = '../auth/login.html';
                    } else {
                        errorContainer.innerHTML = `<div>${result.message || 'Không thể tải thông báo'}</div>`;
                    }
                }
            } catch (error) {
                loadingContainer.style.display = 'none';
                errorContainer.innerHTML = `<div>Lỗi: ${error.message}</div>`;
            }
        }

        async function markAsRead(notificationId) {
            try {
                const result = await userAPI.markNotificationRead(notificationId);
                if (result.success) {
                    showMessage(result.message || 'Đã đánh dấu đã đọc', 'success');
                    await loadNotifications(currentPage);
                } else {
                    showMessage(result.message || 'Thất bại', 'error');
                }
            } catch (error) {
                showMessage('Có lỗi xảy ra', 'error');
            }
        }

        async function deleteNotification(notificationId) {
            if (!confirm('Bạn có chắc muốn xóa thông báo này?')) {
                return;
            }

            try {
                const result = await userAPI.deleteNotification(notificationId);
                if (result.success) {
                    showMessage(result.message || 'Đã xóa thông báo', 'success');
                    await loadNotifications(currentPage);
                } else {
                    showMessage(result.message || 'Xóa thất bại', 'error');
                }
            } catch (error) {
                showMessage('Có lỗi xảy ra', 'error');
            }
        }

        function displayPagination(pagination, container) {
            if (!pagination || pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<div>';
            
            if (pagination.page > 1) {
                html += `<button onclick="loadNotifications(${pagination.page - 1})">Trước</button>`;
            }
            
            html += `<span>Trang ${pagination.page} / ${pagination.pages}</span>`;
            
            if (pagination.page < pagination.pages) {
                html += `<button onclick="loadNotifications(${pagination.page + 1})">Sau</button>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const isValid = await verifyTokenWithBackend();
            if (!isValid) {
                window.location.href = '../auth/login.html';
                return;
            }
            await loadNotifications(1);
        });
    </script>
</body>
</html>

