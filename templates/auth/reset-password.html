<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt Lại Mật Khẩu - Hotel Booking</title>
</head>
<body>
    <div>
        <div>
            <h1>Đặt Lại Mật Khẩu</h1>
            <p>Nhập mật khẩu mới cho tài khoản của bạn</p>
        </div>
        
        <div>
            <div id="errorContainer"></div>
            <div id="successContainer"></div>
            
            <div id="formState">
                <form id="resetPasswordForm">
                    <div>
                        <label for="token">Mã Token</label>
                        <input 
                            type="text" 
                            id="token" 
                            name="token" 
                            required 
                            placeholder="Nhập mã token từ email"
                            value=""
                        >
                        <small>
                            Mã token được gửi qua email khi bạn yêu cầu đặt lại mật khẩu
                        </small>
                    </div>

                    <div>
                        <label for="newPassword">Mật khẩu mới</label>
                        <div>
                            <input 
                                type="password" 
                                id="newPassword" 
                                name="newPassword" 
                                required 
                                placeholder="Nhập mật khẩu mới"
                                autocomplete="new-password"
                                oninput="checkPasswordStrength()"
                            >
                            <button type="button" onclick="togglePassword('newPassword')">
                                <span id="newPasswordToggleText">Hiện</span>
                            </button>
                        </div>
                        <div>
                            <div>
                                <div id="passwordStrengthFill"></div>
                            </div>
                            <span id="passwordStrengthText"></span>
                        </div>
                    </div>

                    <div>
                        <label for="confirmPassword">Xác nhận mật khẩu</label>
                        <div>
                            <input 
                                type="password" 
                                id="confirmPassword" 
                                name="confirmPassword" 
                                required 
                                placeholder="Nhập lại mật khẩu mới"
                                autocomplete="new-password"
                            >
                            <button type="button" onclick="togglePassword('confirmPassword')">
                                <span id="confirmPasswordToggleText">Hiện</span>
                            </button>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn">
                        Đặt Lại Mật Khẩu
                    </button>
                </form>

                <div>
                    Nhớ mật khẩu? <a href="login.html">Đăng nhập ngay</a>
                </div>
            </div>

            <div id="successState" style="display: none;">
                <div>
                    <div>✓</div>
                    <h2>Đặt Lại Mật Khẩu Thành Công!</h2>
                    <p>
                        Mật khẩu của bạn đã được đặt lại thành công. 
                        Bây giờ bạn có thể đăng nhập bằng mật khẩu mới.
                    </p>
                    <button type="button" onclick="window.location.href='login.html'">
                        Đăng Nhập Ngay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            let token = urlParams.get('token');
            
            if (token) {
                localStorage.setItem('reset_password_token', token);
                document.getElementById('token').value = token;
            } else {
                token = localStorage.getItem('reset_password_token');
                if (token) {
                    document.getElementById('token').value = token;
                }
            }
        });

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggleText = document.getElementById(inputId + 'ToggleText');
            
            if (input.type === 'password') {
                input.type = 'text';
                toggleText.textContent = 'Ẩn';
            } else {
                input.type = 'password';
                toggleText.textContent = 'Hiện';
            }
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthText = document.getElementById('passwordStrengthText');
            
            if (password.length === 0) {
                strengthText.textContent = '';
                return;
            }

            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;

            if (strength <= 1) {
                strengthText.textContent = 'Mật khẩu yếu';
            } else if (strength === 2) {
                strengthText.textContent = 'Mật khẩu trung bình';
            } else {
                strengthText.textContent = 'Mật khẩu mạnh';
            }
        }

        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const errorContainer = document.getElementById('errorContainer');
            const successContainer = document.getElementById('successContainer');
            const formState = document.getElementById('formState');
            const successState = document.getElementById('successState');
            
            const token = document.getElementById('token').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            errorContainer.innerHTML = '';
            successContainer.innerHTML = '';

            if (!token || !newPassword || !confirmPassword) {
                errorContainer.innerHTML = '<div>Vui lòng điền đầy đủ thông tin</div>';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorContainer.innerHTML = '<div>Mật khẩu xác nhận không khớp</div>';
                return;
            }

            if (newPassword.length < 6) {
                errorContainer.innerHTML = '<div>Mật khẩu phải có ít nhất 6 ký tự</div>';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Đang đặt lại mật khẩu...';

            try {
                const result = await authAPI.resetPassword(token, newPassword);

                if (result.success) {
                    localStorage.removeItem('reset_password_token');
                    formState.style.display = 'none';
                    successState.style.display = 'block';
                    showMessage(result.message || 'Đặt lại mật khẩu thành công!', 'success');
                } else {
                    errorContainer.innerHTML = `<div>${result.message || 'Đặt lại mật khẩu thất bại'}</div>`;
                    showMessage(result.message || 'Đặt lại mật khẩu thất bại', 'error');
                }
            } catch (error) {
                errorContainer.innerHTML = `<div>Lỗi: ${error.message}</div>`;
                showMessage('Có lỗi xảy ra. Vui lòng thử lại.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Đặt Lại Mật Khẩu';
            }
        });
    </script>
</body>
</html>

